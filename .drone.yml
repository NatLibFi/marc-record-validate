---
kind: pipeline
type: docker
name: Default

trigger:
  event:
    - push
    - tag

steps:
  - name: Audit
    image: node:12
    commands:
      - npm audit --package-lock-only --production --audit-level=moderate

  - name: Install
    image: node:12
    environment:
      NPM_CONFIG_IGNORE_SCRIPTS: true
    commands:
      - npm ci

  - name: Test
    image: node:12
    commands:
      - npm test

  - name: Build
    image: node:12
    commands:
    - npm run build
    - npm ci --production

  - name: Static-security-scan
    image: quay.io/natlibfi/njsscan
    commands:
      - njsscan dist

  - name: Npm
    image: plugins/npm
    settings:
      registry: 'https://registry.npmjs.org/'
      token:
        from_secret: npm_token
    when:
      event: tag
---
kind: pipeline
type: docker
name: Update dependencies

trigger:
  event:
    - custom
  branch:
    - master

steps:
  - name: Publish
    image: quay.io/natlibfi/drone-npm-git-publish
    settings:
      git_user_name: natlibfi-melinda-automation
      git_user_email: 65649125+natlibfi-melinda-automation@users.noreply.github.com
      git_ssh_key:
        from_secret: ssh_key
      git_gpg_key:
        from_secret: gpg_key
---
kind: secret
name: npm_token
data: -
---
kind: secret
name: ssh_key
data: -
---
kind: secret
name: gpg_key
data: -
...
